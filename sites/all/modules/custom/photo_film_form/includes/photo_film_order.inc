<?php
/**
 * File that handles the second step of the photo_film_form multi step form.
 * Including submit, validate and theme functions.
 */

/**
 * Generate second step of the photo_film_form multi step form.
 */
function photo_film_form_order($form, &$form_state) {
  unset($form['ctools_trail']);
  unset($form['buttons']['cancel']);
  unset($form['buttons']['previous']);
  // get the form previous step info
  $cache = photo_film_form_cache_get(1);

  $form['#attributes'] = array();
  $form['#attributes']['class'] = array();
  $form['#attributes']['class'][] = 'photo-film-form';
  $form['#attributes']['class'][] = 'order-form';

  $form['title'] = array(
    '#type' => 'markup',
    '#markup' => '<h4>' . variable_get('photo_film_form_order_title', '') . '</h4>',
    '#weight' => -20,
  );

  $form['theme'] = array(
    '#type' => 'textfield',
    '#title' => t('Theme') . ':',
    '#disabled' => TRUE,
    '#weight' => -19
  );
  // provide value that user picked up at first step
  if (!empty($cache->theme['theme']) && $theme = $cache->theme['theme']) {
    $theme = taxonomy_term_load($theme);
    $form['theme']['#value'] = (!empty($theme->name) ? $theme->name : '');
  }

  $form['style'] = array(
    '#type' => 'textfield',
    '#title' => t('Style') . ':',
    '#disabled' => TRUE,
    '#weight' => -17
  );
  // provide value that user picked up at second step
  if (!empty($cache->style['style']) && $style = $cache->style['style']) {
    $style = taxonomy_term_load($style);
    $form['style']['#value'] = (!empty($style->name) ? $style->name : '');
  }

  $form['music'] = array(
    '#type' => 'textfield',
    '#title' => t('Music') . ':',
    '#disabled' => TRUE,
    '#value' => 'picked music track',
    '#weight' => -15
  );

  // provide value that user picked up at third step
  if (!empty($cache->music['fid']) && $music = $cache->music['fid']) {
    $file = file_load($music);
    $form['music']['#value'] = (!empty($file->filename) ? $file->filename : '');
  }

  $form['name'] = array(
    '#type' => 'textfield',
    '#title' => t('Name') . ':',
    '#weight' => -18
  );

  $form['country'] = array(
    '#type' => 'textfield',
    '#title' => t('Country') . ':',
    '#rules' => array(
      'alpha',
    ),
    '#weight' => -16
  );

  $form['city'] = array(
    '#type' => 'textfield',
    '#title' => t('City') . ':',
    '#rules' => array(
      'alpha',
    ),
    '#weight' => -14
  );

  $form['email'] = array(
    '#type' => 'textfield',
    '#title' => t('Email') . ':',
    '#rules' => array(
      'email',
    ),
    '#required' => TRUE,
    '#weight' => -12
  );

  $form['mobile'] = array(
    '#type' => 'textfield',
    '#title' => t('Mobile') . ':',
    '#required' => TRUE,
    '#weight' => -10
  );

  $options = array();
  if ($themes_vocabulary_vid = variable_get('photo_film_form_video_formats_vid', FALSE)) {
    if ($terms = taxonomy_get_tree($themes_vocabulary_vid)) {
      foreach ($terms as $term) {
        $options[$term->tid] = $term->name;
      }
    }
  }
  // todo make it with default value which is unexceptable for validation
  $form['format'] = array(
    '#type' => 'select',
    '#title' => t('Format') . ':',
    '#required' => TRUE,
    '#options' => $options,
    '#default_value' => 'key',
    '#ajax' => array(
      'callback' => 'photo_film_form_order_get_amount',
      'wrapper' => 'order-amount',
      'method' => 'replace',
      'effect' => 'none',
    ),
    '#weight' => -13,
    '#prefix' => '<div class="form-delimeter">&nbsp;</div>'
  );

  $options = array();
  if ($themes_vocabulary_vid = variable_get('photo_film_form_delivery_methods', FALSE)) {
    if ($terms = taxonomy_get_tree($themes_vocabulary_vid)) {
      foreach ($terms as $term) {
        $options[$term->tid] = $term->name;
      }
    }
  }

  $form['delivery'] = array(
    '#type' => 'select',
    '#title' => t('Delivery method') . ':',
    '#required' => TRUE,
    '#default_value' => 'key',
    '#options' => $options,
    '#weight' => -11
  );

  $form['separator'] = array(
    '#type' => 'markup',
    '#markup' => '<hr class="separator" />',
    '#weight' => -9
  );

  $form['discount'] = array(
    '#type' => 'textfield',
    '#title' => t('Discount') . ':',
    '#weight' => -8
  );

  // finish step submit button
  if (!empty($form['buttons']['return'])) {
    $form['buttons']['return']['#value'] = t("Send");
    $form['buttons']['return'] = photo_film_form_render_submit_button($form['buttons']['return'], "");
  }

  $amount = photo_film_form_calculate_amount($cache);
  $form['total'] = photo_film_form_order_get_amount_element($amount);

  // Webmoney inputs
  $form['#action'] = 'https://merchant.webmoney.ru/lmi/payment.asp';

  $form['LMI_PAYEE_PURSE'] = array(
    '#type' => 'hidden',
    '#value' => variable_get('photo_film_form_webmoney_pursues', ''),
  );
  watchdog('asdad', $form['total']['#amount']);
  $form['LMI_PAYMENT_AMOUNT'] = array(
    '#type' => 'hidden',
    // todo do it in right way
    '#value' => 10,
  );

  return $form;
}

/**
 * Form submit function for photo_film_form_order
 */
function photo_film_form_order_submit($form, &$form_state) {
  if (!empty($form_state['object'])) {
    $form_state['object']->current_step = 'order_info';
    $form_state['object']->order_info = array(
      'name' => !empty($form_state['values']['name']) ? $form_state['values']['name'] : '',
      'country' => !empty($form_state['values']['country']) ? $form_state['values']['country'] : '',
      'city' => !empty($form_state['values']['city']) ? $form_state['values']['city'] : '',
      'email' => !empty($form_state['values']['email']) ? $form_state['values']['email'] : '',
      'mobile' => !empty($form_state['values']['mobile']) ? $form_state['values']['mobile'] : '',
      'format' => !empty($form_state['values']['format']) ? $form_state['values']['format'] : '',
      'delivery' => !empty($form_state['values']['delivery']) ? $form_state['values']['delivery'] : '',
      'discount' => !empty($form_state['values']['format']) ? $form_state['values']['format'] : '',
    );
  }
}
